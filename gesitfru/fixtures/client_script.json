[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DEBIT NOTE",
  "enabled": 1,
  "modified": "2025-11-27 19:52:14.040132",
  "module": null,
  "name": "DN_calc",
  "script": "frappe.ui.form.on(\"DEBIT NOTE\", {\n    premium: calculate_total,\n    discount: calculate_total,\n    policy_cost: calculate_total,\n    refresh: calculate_total,\n});\n\nfunction calculate_total(frm) {\n\n    let premium = frm.doc.premium || 0;\n    let discount = frm.doc.discount || 0;\n    let policy_cost = frm.doc.policy_cost || 0;\n\n    let total = (premium - discount) + policy_cost;\n    frm.set_value(\"total_due_to_us\", total);\n\n    frappe.call({\n        method: \"gesitfru.gesitfru.api.debit_note.get_money_in_words\",\n        args: { number: total },\n        callback: function(r) {\n            if (r.message) {\n                frm.set_value(\"say\", r.message);\n            }\n        }\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "DEBIT NOTE",
  "enabled": 1,
  "modified": "2025-12-10 18:37:45.880097",
  "module": null,
  "name": "DEBIT NOTE to CS",
  "script": "frappe.ui.form.on('DEBIT NOTE', {\n    refresh(frm) {\n        if (!frm.is_new()) {\n\n            frm.add_custom_button(\"Create CS\", () => {\n                frappe.call({\n                    method: \"gesitfru.gesitfru.api.cs_api.create_cs_from_dn\",\n                    args: { dn_name: frm.doc.name },\n                    callback: (r) => {\n                        if (r.message) {\n                            frappe.set_route(\"Form\", \"CS\", r.message);\n                        }\n                    }\n                });\n            });\n\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CS",
  "enabled": 0,
  "modified": "2025-12-14 19:39:55.445085",
  "module": null,
  "name": "cs3",
  "script": "// =====================================================\n// CHILD TABLE EVENTS (PREMIUM DETAILS)\n// =====================================================\nfrappe.ui.form.on('PREMIUM DETAILS', {\n    share: on_child_change,\n    discount_percent: on_child_change,\n    bkg_percent: on_child_change,\n    ef_percent: on_child_change\n});\n\n// =====================================================\n// PARENT EVENTS (CS)\n// =====================================================\nfrappe.ui.form.on('CS', {\n    premium_detail_add(frm) {\n        calculate_grand_total(frm);\n    },\n    premium_detail_remove(frm) {\n        calculate_grand_total(frm);\n    },\n    refresh(frm) {\n        calculate_grand_total(frm);\n    },\n    gross_premium(frm) {\n        recalc_all_rows(frm);\n    },\n    policy_cost(frm) {\n        recalc_all_rows(frm);\n    }\n});\n\n// =====================================================\n// HANDLER\n// =====================================================\nfunction on_child_change(frm, cdt, cdn) {\n    recalc_row(frm, cdt, cdn);\n    calculate_grand_total(frm);\n}\n\n// =====================================================\n// RECALC ALL ROWS (WHEN PARENT CHANGES)\n// =====================================================\nfunction recalc_all_rows(frm) {\n    (frm.doc.premium_detail || []).forEach(row => {\n        recalc_row(frm, row.doctype, row.name);\n    });\n    calculate_grand_total(frm);\n}\n\n// =====================================================\n// ROW CALCULATION\n// =====================================================\nfunction recalc_row(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n\n    let gross_premium = flt(frm.doc.gross_premium);\n\n    // Percent fields already 0–100\n    let share = flt(row.share) / 100;\n    let discount_rate = flt(row.discount_percent) / 100;\n    let bkg_rate = flt(row.bkg_percent) / 100;\n    let ef_rate = flt(row.ef_percent) / 100;\n\n    let gross = gross_premium * share;\n    let discount = gross * discount_rate;\n    let bkg = gross * bkg_rate;\n    let ef = gross * ef_rate;\n\n    let total_premium = gross - discount - bkg - ef;\n    let pph = bkg * 0.02;\n    let ppn = bkg * 0.022;\n    let adm_cost = flt(frm.doc.policy_cost);\n    let nett_due = total_premium + pph + adm_cost;\n\n    frappe.model.set_value(cdt, cdn, 'gross', gross);\n    frappe.model.set_value(cdt, cdn, 'discount', discount);\n    frappe.model.set_value(cdt, cdn, 'bkg', bkg);\n    frappe.model.set_value(cdt, cdn, 'ef', ef);\n    frappe.model.set_value(cdt, cdn, 'total_premium', total_premium);\n    frappe.model.set_value(cdt, cdn, 'pph', pph);\n    frappe.model.set_value(cdt, cdn, 'ppn', ppn);\n    frappe.model.set_value(cdt, cdn, 'adm_cost', adm_cost);\n    frappe.model.set_value(cdt, cdn, 'nett_due', nett_due);\n}\n\n// =====================================================\n// GRAND TOTAL (CS)\n// =====================================================\nfunction calculate_grand_total(frm) {\n\n    let totals = {\n        gross: 0,\n        discount: 0,\n        bkg: 0,\n        ef: 0,\n        pph: 0,\n        ppn: 0,\n        nett: 0\n    };\n\n    (frm.doc.premium_detail || []).forEach(r => {\n        totals.gross += flt(r.gross);\n        totals.discount += flt(r.discount);\n        totals.bkg += flt(r.bkg);\n        totals.ef += flt(r.ef);\n        totals.pph += flt(r.pph);\n        totals.ppn += flt(r.ppn);\n        totals.nett += flt(r.nett_due);\n    });\n\n    frm.set_value('total_gross', totals.gross);\n    frm.set_value('total_discount', totals.discount);\n    frm.set_value('total_bkg', totals.bkg);\n    frm.set_value('total_ef', totals.ef);\n    frm.set_value('total_pph', totals.pph);\n    frm.set_value('total_ppn', totals.ppn);\n    frm.set_value('total_nett_due', totals.nett);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "CS",
  "enabled": 1,
  "modified": "2025-12-30 17:23:51.115163",
  "module": null,
  "name": "CS4",
  "script": "// =====================================================\n// CHILD TABLE EVENTS (PREMIUM DETAILS)\n// =====================================================\nfrappe.ui.form.on('PREMIUM DETAILS', {\n    share: on_child_change,\n    discount_percent: on_child_change,\n    bkg_percent: on_child_change,\n    ef_percent: on_child_change\n});\n\n// =====================================================\n// PARENT EVENTS (CS)\n// =====================================================\nfrappe.ui.form.on('CS', {\n\n    premium_detail_add(frm) {\n        calculate_grand_total(frm);\n    },\n\n    premium_detail_remove(frm) {\n        calculate_grand_total(frm);\n    },\n\n    refresh(frm) {\n        calculate_grand_total(frm);\n    },\n\n    gross_premium(frm) {\n        recalc_all_rows(frm);\n    },\n\n    policy_cost(frm) {\n        // policy cost hanya mempengaruhi total\n        calculate_grand_total(frm);\n    }\n});\n\n// =====================================================\n// CHILD HANDLER\n// =====================================================\nfunction on_child_change(frm, cdt, cdn) {\n    recalc_row(frm, cdt, cdn);\n    calculate_grand_total(frm);\n}\n\n// =====================================================\n// RECALC ALL ROWS\n// =====================================================\nfunction recalc_all_rows(frm) {\n    (frm.doc.premium_detail || []).forEach(row => {\n        recalc_row(frm, row.doctype, row.name);\n    });\n    calculate_grand_total(frm);\n}\n\n// =====================================================\n// ROW CALCULATION (NO POLICY COST HERE)\n// =====================================================\nfunction recalc_row(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n\n    let gross_premium = flt(frm.doc.gross_premium);\n\n    // Percent values (0–100)\n    let share = flt(row.share) / 100;\n    let discount_rate = flt(row.discount_percent) / 100;\n    let bkg_rate = flt(row.bkg_percent) / 100;\n    let ef_rate = flt(row.ef_percent) / 100;\n\n    let gross = gross_premium * share;\n    let discount = gross * discount_rate;\n    let bkg = gross * bkg_rate;\n    let ef = gross * ef_rate;\n\n    let total_premium = gross - discount - bkg - ef;\n    let pph = bkg * 0.02;\n    let ppn = bkg * 0.022;\n\n    // Nett per row TANPA policy_cost\n    let nett_due = total_premium + pph;\n\n    frappe.model.set_value(cdt, cdn, {\n        gross: gross,\n        discount: discount,\n        bkg: bkg,\n        ef: ef,\n        total_premium: total_premium,\n        pph: pph,\n        ppn: ppn,\n        nett_due: nett_due\n    });\n}\n\n// =====================================================\n// GRAND TOTAL (CS) - POLICY COST APPLIED ONCE\n// =====================================================\nfunction calculate_grand_total(frm) {\n\n    let totals = {\n        gross: 0,\n        discount: 0,\n        bkg: 0,\n        ef: 0,\n        pph: 0,\n        ppn: 0,\n        nett: 0\n    };\n\n    (frm.doc.premium_detail || []).forEach(r => {\n        totals.gross += flt(r.gross);\n        totals.discount += flt(r.discount);\n        totals.bkg += flt(r.bkg);\n        totals.ef += flt(r.ef);\n        totals.pph += flt(r.pph);\n        totals.ppn += flt(r.ppn);\n        totals.nett += flt(r.nett_due);\n    });\n\n    let policy_cost = flt(frm.doc.policy_cost);\n\n    frm.set_value('total_gross', totals.gross);\n    frm.set_value('total_discount', totals.discount);\n    frm.set_value('total_bkg', totals.bkg);\n    frm.set_value('total_ef', totals.ef);\n    frm.set_value('total_pph', totals.pph);\n    frm.set_value('total_ppn', totals.ppn);\n\n    // Policy cost ditambahkan SEKALI SAJA\n    frm.set_value('total_nett_due', totals.nett + policy_cost);\n    frm.set_value('total_pendapatan', totals.bkg + totals.ef);\n}\n",
  "view": "Form"
 }
]